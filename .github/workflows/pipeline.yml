name: Narrative Detection Pipeline

on:
  # Fortnightly schedule: 1st and 15th of each month at 06:00 UTC
  schedule:
    - cron: '0 6 1 * *'   # 1st of every month
    - cron: '0 6 15 * *'  # 15th of every month

  # Manual trigger with optional date range
  workflow_dispatch:
    inputs:
      period_start:
        description: 'Period start date (YYYY-MM-DD), defaults to 14 days ago'
        required: false
        type: string
      period_end:
        description: 'Period end date (YYYY-MM-DD), defaults to today'
        required: false
        type: string

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  MOONSHOT_API_KEY: ${{ secrets.MOONSHOT_API_KEY }}
  MOONSHOT_MODEL: ${{ vars.MOONSHOT_MODEL || 'kimi-k2-turbo-preview' }}
  HELIUS_API_KEY: ${{ secrets.HELIUS_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.GH_TOKEN_CUSTOM }}
  ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
  NODE_ENV: production

jobs:
  run-pipeline:
    name: Run Narrative Detection
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: cd apps/web && npx prisma@5 generate

      - name: Run pipeline
        env:
          INPUT_START: ${{ github.event.inputs.period_start }}
          INPUT_END: ${{ github.event.inputs.period_end }}
        run: |
          ARGS=""
          if [ -n "$INPUT_START" ]; then
            if [[ ! "$INPUT_START" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              echo "❌ Invalid period_start format (expected YYYY-MM-DD): $INPUT_START"
              exit 1
            fi
            ARGS="$ARGS --start $INPUT_START"
          fi
          if [ -n "$INPUT_END" ]; then
            if [[ ! "$INPUT_END" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              echo "❌ Invalid period_end format (expected YYYY-MM-DD): $INPUT_END"
              exit 1
            fi
            ARGS="$ARGS --end $INPUT_END"
          fi
          echo "Running pipeline with args: $ARGS"
          pnpm --filter web pipeline:run $ARGS

      - name: Report status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Pipeline completed successfully"
          else
            echo "❌ Pipeline failed — check logs above"
          fi
